<!DOCTYPE html>
<html>
<head>
    <title>TIS Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-1: #eff4fb;
            --bg-2: #dce8f4;
            --ink: #11243f;
            --muted: #536782;
            --card: #ffffff;
            --line: #cad9ea;
            --brand: #0a4ea3;
            --brand-deep: #073a7d;
            --accent: #c79a14;
            --teal: #0f7f7a;
            --danger: #b91c1c;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            color: var(--ink);
            font-family: "Trebuchet MS", "Lucida Sans Unicode", "Segoe UI", sans-serif;
            background:
                radial-gradient(900px 500px at 10% 0%, rgba(10, 78, 163, 0.2), transparent 65%),
                radial-gradient(700px 420px at 100% 100%, rgba(199, 154, 20, 0.18), transparent 62%),
                linear-gradient(150deg, var(--bg-1), var(--bg-2));
            padding: 30px 16px;
        }

        .app {
            max-width: 1180px;
            margin: 0 auto;
            animation: rise 450ms ease-out;
        }

        .topbar {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 18px;
            padding: 18px 22px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-frame {
            width: clamp(140px, 18vw, 220px);
            flex-shrink: 0;
        }

        .logo {
            width: 100%;
            height: auto;
            display: block;
        }

        .topbar-school-logos {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .topbar-school-logo {
            width: clamp(130px, 14vw, 187px);
            flex-shrink: 0;
        }

        .topbar-school-logo-main {
            width: clamp(138px, 16vw, 210px);
            flex-shrink: 0;
        }

        .topbar-cognia-logo {
            width: clamp(132px, 15vw, 192px);
            flex-shrink: 0;
        }

        .topbar-school-logo img,
        .topbar-school-logo-main img,
        .topbar-cognia-logo img {
            width: 100%;
            height: auto;
            display: block;
        }

        .tab-icon {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }

        .meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            text-align: right;
            margin-left: 0;
        }

        .meta h2 {
            margin: 0;
            font-size: 18px;
        }

        .meta p {
            margin: 4px 0;
            font-size: 13px;
            color: var(--muted);
        }

        .meta-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .meta-actions .logout {
            order: 1;
        }

        .meta-actions .dev-menu {
            order: 2;
        }

        .icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }

        .icon-action {
            width: 30px;
            height: 30px;
            border: 1px solid #c6d4e8;
            border-radius: 8px;
            color: #48607f;
            background: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            cursor: pointer;
            transition: color 120ms ease, border-color 120ms ease, background-color 120ms ease, transform 120ms ease;
        }

        .icon-action:hover {
            color: var(--brand-deep);
            border-color: #8aaedf;
            background: #edf4ff;
            transform: translateY(-1px);
        }

        .icon-action:focus-visible {
            outline: 2px solid rgba(10, 78, 163, 0.35);
            outline-offset: 2px;
        }

        .icon-action.disabled {
            opacity: 0.55;
            cursor: not-allowed;
            pointer-events: none;
            transform: none;
        }

        .logout {
            display: inline-block;
            font-size: 13px;
            text-decoration: none;
            color: #fff;
            background: var(--danger);
            padding: 7px 10px;
            border-radius: 8px;
        }

        .dev-menu {
            position: relative;
        }

        .dev-menu summary {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            list-style: none;
            cursor: pointer;
            user-select: none;
            border: 1px solid #9fbbe0;
            background: rgba(255, 255, 255, 0.92);
            color: var(--brand-deep);
            border-radius: 9px;
            padding: 7px 11px;
            font-size: 13px;
            font-weight: 700;
        }

        .dev-menu summary::-webkit-details-marker {
            display: none;
        }

        .dev-menu[open] summary {
            border-color: var(--brand);
            background: #edf4ff;
        }

        .dev-menu-panel {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: min(560px, calc(100vw - 40px));
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.16);
            z-index: 40;
        }

        .dev-group + .dev-group {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px dashed #c5d4e7;
        }

        .dev-group h3 {
            margin: 0;
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        .dev-group-title {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            color: var(--brand-deep);
        }

        .dev-group p {
            margin: 6px 0 10px;
            font-size: 12px;
            color: var(--muted);
        }

        .dev-form + .dev-form {
            margin-top: 10px;
        }

        .dev-form label {
            display: block;
            margin: 0 0 5px;
            font-size: 12px;
            font-weight: 700;
            color: #3b4860;
        }

        .dev-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .dev-row-single {
            grid-template-columns: 1fr;
        }

        .dev-row select,
        .dev-row input {
            width: 100%;
            min-width: 0;
            padding: 8px 10px;
            border: 1px solid #b8c6da;
            border-radius: 8px;
            font-size: 13px;
            background: #fff;
        }

        .dev-row button,
        .dev-row .dev-link {
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            background: var(--brand);
            white-space: nowrap;
        }

        .dev-row .dev-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            width: fit-content;
        }

        .stats {
            margin-top: 16px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 14px;
        }

        .notice {
            margin-top: 12px;
            border: 1px solid #b8cde9;
            background: #edf4ff;
            color: #123d72;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 700;
        }

        .stat {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
        }

        .stat span {
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .stat strong {
            display: block;
            margin-top: 6px;
            font-size: 30px;
            line-height: 1;
        }

        .workspace {
            margin-top: 16px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 14px;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(120deg, rgba(10, 78, 163, 0.09), rgba(199, 154, 20, 0.12));
        }

        .tab {
            border: 1px solid #9fbbe0;
            background: rgba(255, 255, 255, 0.65);
            color: var(--brand-deep);
            border-radius: 999px;
            padding: 8px 14px;
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 120ms ease, background-color 120ms ease;
        }

        .tab:hover {
            transform: translateY(-1px);
        }

        .tab.active {
            color: #fff;
            border-color: var(--brand);
            background: var(--brand);
        }

        .panel {
            display: none;
            padding: 18px;
            animation: rise 260ms ease-out;
        }

        .panel.active {
            display: block;
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .panel-head h3 {
            margin: 0;
            font-size: 20px;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-head p {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 13px;
        }

        .open-link {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 10px;
            text-decoration: none;
            color: #fff;
            background: var(--brand);
            font-size: 13px;
            font-weight: 700;
        }

        .open-link.disabled {
            pointer-events: none;
            background: #8b97ab;
        }

        .table-wrap {
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 560px;
        }

        th, td {
            padding: 11px 12px;
            border-bottom: 1px solid #e6edf6;
            text-align: left;
            font-size: 14px;
        }

        th {
            background: #f0f5fb;
            color: #30456b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .empty {
            padding: 24px;
            border: 1px dashed #9cb0cc;
            border-radius: 12px;
            background: #f8fbff;
            color: #42566f;
            text-align: center;
        }

        .subject-level-dashboard {
            border: 1px solid #d4e1f3;
            border-radius: 12px;
            background: linear-gradient(145deg, #fbfdff, #f3f8ff);
            padding: 12px;
            margin-bottom: 10px;
        }

        .subject-level-kpis {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }

        .subject-level-kpi {
            border: 1px solid #d6e2f4;
            border-radius: 10px;
            background: #fff;
            padding: 10px;
        }

        .subject-level-kpi span {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #4a607f;
            font-weight: 700;
        }

        .subject-level-kpi strong {
            display: block;
            margin-top: 4px;
            font-size: 26px;
            line-height: 1.1;
            color: #1b3154;
        }

        .subject-level-kpi small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #536885;
        }

        .subject-grade-chip-bar {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .subject-grade-chip {
            border: 1px solid #b7c9e2;
            background: #fff;
            color: #325077;
            border-radius: 999px;
            padding: 7px 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 120ms ease, border-color 120ms ease, background-color 120ms ease, color 120ms ease;
        }

        .subject-grade-chip:hover {
            transform: translateY(-1px);
            border-color: #8aaedf;
            background: #edf4ff;
            color: #083b7e;
        }

        .subject-grade-chip.active {
            border-color: var(--brand);
            background: var(--brand);
            color: #fff;
        }

        .subject-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        .subject-filter-input {
            width: 320px;
            max-width: 100%;
            padding: 9px 10px;
            border: 1px solid #c6d4e8;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
        }

        .tiles {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .tile {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
            background: #fbfcff;
        }

        .tile h4 {
            margin: 0 0 8px;
            font-size: 15px;
        }

        .tile p {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }

        .planning-metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .planning-kpi {
            position: relative;
            overflow: hidden;
            border: 1px solid #d3deed;
            border-radius: 12px;
            padding: 14px;
            background: linear-gradient(145deg, #fbfdff, #f1f7ff);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
            transition: transform 140ms ease, box-shadow 140ms ease;
        }

        .planning-kpi:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        .planning-kpi::after {
            content: "";
            position: absolute;
            inset: auto 0 0 0;
            height: 4px;
            background: #b5c9e8;
        }

        .planning-kpi-current::after {
            background: var(--teal);
        }

        .planning-kpi-new::after {
            background: var(--accent);
        }

        .planning-kpi-hours::after {
            background: #2563eb;
        }

        .planning-kpi span {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #4d607e;
            font-weight: 700;
        }

        .planning-kpi strong {
            display: block;
            margin-top: 6px;
            font-size: 34px;
            line-height: 1.1;
            color: #142b4d;
        }

        .planning-kpi p {
            margin-top: 6px;
            margin-bottom: 0;
            font-size: 13px;
            color: #536885;
            line-height: 1.4;
        }

        .report-note {
            margin-bottom: 12px;
            border: 1px solid #bfd2ea;
            background: #f1f6ff;
            color: #123d72;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .report-decision-strip {
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .report-decision-card {
            position: relative;
            overflow: hidden;
            border: 1px solid #d3deed;
            border-radius: 12px;
            padding: 14px;
            background: linear-gradient(145deg, #fbfdff, #f1f7ff);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
        }

        .report-decision-card::after {
            content: "";
            position: absolute;
            inset: auto 0 0 0;
            height: 5px;
            background: #94a3b8;
        }

        .report-decision-classes::after {
            background: #1d4ed8;
        }

        .report-decision-new-teachers::after {
            background: var(--accent);
        }

        .report-decision-total::after {
            background: var(--brand);
        }

        .report-decision-card span {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #4d607e;
            font-weight: 700;
        }

        .report-decision-card strong {
            display: block;
            margin-top: 6px;
            font-size: 42px;
            line-height: 1.05;
            color: #142b4d;
        }

        .report-decision-new-teachers strong {
            color: #966f00;
        }

        .report-decision-total strong {
            color: var(--brand);
        }

        .report-decision-card p {
            margin: 6px 0 0;
            font-size: 13px;
            color: #536885;
            line-height: 1.4;
        }

        .report-kpis {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
        }

        .report-kpi {
            position: relative;
            overflow: hidden;
            border: 1px solid #d3deed;
            border-radius: 12px;
            padding: 14px;
            background: linear-gradient(145deg, #fbfdff, #f1f7ff);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
        }

        .report-kpi::after {
            content: "";
            position: absolute;
            inset: auto 0 0 0;
            height: 4px;
            background: #b5c9e8;
        }

        .report-kpi-hours::after {
            background: #2563eb;
        }

        .report-kpi-covered::after {
            background: var(--brand);
        }

        .report-kpi-gap::after {
            background: var(--accent);
        }

        .report-kpi-teachers::after {
            background: #1d4ed8;
        }

        .report-kpi span {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #4d607e;
            font-weight: 700;
        }

        .report-kpi strong {
            display: block;
            margin-top: 6px;
            font-size: 30px;
            line-height: 1.1;
            color: #142b4d;
        }

        .report-kpi p {
            margin: 6px 0 0;
            font-size: 13px;
            color: #536885;
            line-height: 1.4;
        }

        .report-coverage {
            margin-top: 12px;
            border: 1px solid #d5e2f2;
            border-radius: 12px;
            background: #f9fbff;
            padding: 12px;
        }

        .report-coverage-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .report-coverage-meta span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: #4d607e;
            font-weight: 700;
        }

        .report-coverage-rate {
            margin: 0;
            font-size: 30px;
            color: var(--brand);
            letter-spacing: 0.4px;
        }

        .report-coverage-meta small {
            color: #536885;
            font-size: 12px;
        }

        .report-coverage-track {
            margin-top: 10px;
            height: 12px;
            border-radius: 999px;
            background: #e1e9f5;
            overflow: hidden;
        }

        .report-coverage-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--brand), var(--teal));
            transition: width 600ms ease-out;
        }

        .report-layout {
            margin-top: 12px;
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
            gap: 12px;
        }

        .report-card {
            border: 1px solid #d3deed;
            border-radius: 12px;
            background: #fff;
            padding: 14px;
        }

        .report-card h4 {
            margin: 0;
            font-size: 16px;
            color: #1f3559;
        }

        .report-card p {
            margin: 6px 0 10px;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.45;
        }

        .report-table table {
            min-width: 760px;
        }

        .report-status-good {
            color: #0d7a47;
            font-weight: 700;
        }

        .report-status-gap {
            color: #b45309;
            font-weight: 700;
        }

        .report-hours-full {
            color: #0d7a47;
            font-weight: 800;
        }

        .report-hours-under {
            color: #b91c1c;
            font-weight: 800;
        }

        .report-inline-note {
            margin-top: 4px;
            font-size: 12px;
            color: #4f607a;
            line-height: 1.35;
        }

        .report-gap-list {
            display: grid;
            gap: 8px;
        }

        .report-gap-row {
            border: 1px solid #dfebf9;
            border-radius: 10px;
            background: #fbfdff;
            padding: 9px 10px;
        }

        .report-gap-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #1f3559;
        }

        .report-gap-track {
            margin-top: 7px;
            height: 8px;
            border-radius: 999px;
            background: #e4ebf6;
            overflow: hidden;
        }

        .report-gap-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--accent), #e7b640);
            transition: width 600ms ease-out;
        }

        .report-gap-row small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #556981;
        }

        .report-subtitle {
            margin: 12px 0 0;
            font-size: 15px;
            color: #1f3559;
        }

        .report-grade-table {
            margin-top: 8px;
        }

        .report-teachers-card {
            margin-top: 12px;
        }

        .report-footnote {
            margin-top: 10px;
            color: #5b6c83;
            font-size: 12px;
            line-height: 1.4;
        }

        @keyframes rise {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            .topbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .logo-frame {
                width: min(62vw, 240px);
            }

            .topbar-school-logos {
                margin-left: 0;
                gap: 8px;
            }

            .topbar-school-logo {
                width: min(48vw, 180px);
            }

            .topbar-school-logo-main {
                width: min(46vw, 184px);
            }

            .topbar-cognia-logo {
                width: min(44vw, 176px);
            }

            .meta {
                text-align: left;
                align-items: flex-start;
                margin-left: 0;
            }

            .meta-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .dev-menu-panel {
                right: auto;
                left: 0;
                width: min(560px, calc(100vw - 52px));
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .tiles {
                grid-template-columns: 1fr;
            }

            .planning-metrics {
                grid-template-columns: 1fr;
            }

            .subject-level-kpis {
                grid-template-columns: 1fr;
            }

            .report-kpis {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .report-decision-strip {
                grid-template-columns: 1fr;
            }

            .report-layout {
                grid-template-columns: 1fr;
            }

            .subject-toolbar {
                justify-content: stretch;
            }

            .subject-filter-input {
                width: 100%;
            }

            .dev-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .report-kpis {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <section class="topbar">
            <div class="brand">
                <div class="logo-frame">
                    <img class="logo" src="{{ url_for('static', path='images/tis-logo.png') }}" alt="Teacher Information System logo">
                </div>
            </div>
            <div class="topbar-school-logos">
                <div class="topbar-school-logo">
                    <img src="{{ url_for('static', path='images/andalus-logo.png') }}" alt="Little Andalus International Schools logo">
                </div>
                <div class="topbar-school-logo-main">
                    <img src="{{ url_for('static', path='images/andalus-logo-main.png') }}" alt="Andalus International Schools main logo">
                </div>
                <div class="topbar-cognia-logo">
                    <img src="{{ url_for('static', path='images/cognia-logo.png') }}" alt="Cognia logo">
                </div>
            </div>
            <div class="meta">
                <div class="meta-info">
                    <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                    <p>Branch: {{ branch_name }}</p>
                    <p>Academic Year: {{ academic_year_name }}</p>
                </div>
                <div class="meta-actions">
                    <a class="logout" href="/logout">Logout</a>
                    {% if can_manage_system_settings %}
                    <details class="dev-menu">
                        <summary>
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a1.8 1.8 0 0 1 0 2.5 1.8 1.8 0 0 1-2.5 0l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V20a1.8 1.8 0 0 1-1.8 1.8 1.8 1.8 0 0 1-1.8-1.8v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a1.8 1.8 0 0 1-2.5 0 1.8 1.8 0 0 1 0-2.5l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H4a1.8 1.8 0 0 1-1.8-1.8A1.8 1.8 0 0 1 4 10.4h.2a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a1.8 1.8 0 0 1 0-2.5 1.8 1.8 0 0 1 2.5 0l.1.1a1 1 0 0 0 1.1.2 1 1 0 0 0 .6-.9V4a1.8 1.8 0 0 1 1.8-1.8A1.8 1.8 0 0 1 14.8 4v.2a1 1 0 0 0 .6.9 1 1 0 0 0 1.1-.2l.1-.1a1.8 1.8 0 0 1 2.5 0 1.8 1.8 0 0 1 0 2.5l-.1.1a1 1 0 0 0-.2 1.1 1 1 0 0 0 .9.6h.2a1.8 1.8 0 0 1 1.8 1.8 1.8 1.8 0 0 1-1.8 1.8h-.2a1 1 0 0 0-.9.6z"></path>
                            </svg>
                            Developer Menu
                        </summary>
                        <div class="dev-menu-panel">
                            <section class="dev-group">
                                <h3 class="dev-group-title">
                                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M3 6h8"></path>
                                        <path d="M15 6h6"></path>
                                        <circle cx="13" cy="6" r="2"></circle>
                                        <path d="M3 12h3"></path>
                                        <path d="M10 12h11"></path>
                                        <circle cx="8" cy="12" r="2"></circle>
                                        <path d="M3 18h10"></path>
                                        <path d="M17 18h4"></path>
                                        <circle cx="15" cy="18" r="2"></circle>
                                    </svg>
                                    System Configuration
                                </h3>
                                <p>Configure cross-branch and cross-year dashboard scope.</p>

                                <form class="dev-form" method="post" action="/scope/branch">
                                    <label for="scope_branch_id">Branch Scope</label>
                                    <div class="dev-row">
                                        <select id="scope_branch_id" name="branch_id" required>
                                            {% for branch_item in available_scope_branches %}
                                            <option value="{{ branch_item.id }}" {% if scoped_branch_id == branch_item.id %}selected{% endif %}>
                                                {{ branch_item.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit">Switch Branch</button>
                                    </div>
                                </form>

                                <form class="dev-form" method="post" action="/scope/academic-year">
                                    <label for="scope_academic_year_id">Academic Year Scope</label>
                                    <div class="dev-row">
                                        <select id="scope_academic_year_id" name="academic_year_id" required>
                                            {% for year in all_years %}
                                            <option value="{{ year.id }}" {% if scoped_academic_year_id == year.id %}selected{% endif %}>
                                                {{ year.year_name }}{% if active_year_id == year.id %} (Current){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit">Switch Year Scope</button>
                                    </div>
                                </form>
                            </section>

                            <section class="dev-group">
                                <h3 class="dev-group-title">
                                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                        <rect x="3" y="5" width="18" height="16" rx="2"></rect>
                                        <path d="M16 3v4"></path>
                                        <path d="M8 3v4"></path>
                                        <path d="M3 10h18"></path>
                                        <path d="M8 14h3"></path>
                                        <path d="M13 14h3"></path>
                                    </svg>
                                    Academic Year Management
                                </h3>
                                <p>Set the current year and open a new academic year.</p>

                                <form class="dev-form" method="post" action="/admin/current-year">
                                    <label for="academic_year_id">Current Academic Year</label>
                                    <div class="dev-row">
                                        <select id="academic_year_id" name="academic_year_id" required>
                                            {% for year in all_years %}
                                            <option value="{{ year.id }}" {% if active_year_id == year.id %}selected{% endif %}>
                                                {{ year.year_name }}{% if active_year_id == year.id %} (Current){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit">Set Current Year</button>
                                    </div>
                                </form>

                                <form class="dev-form" method="post" action="/developer/open-academic-year">
                                    <label for="year_name">Open New Academic Year</label>
                                    <div class="dev-row">
                                        <input id="year_name" type="text" name="year_name" placeholder="YYYY-YYYY (example: 2026-2027)" required>
                                        <button type="submit">Open New Year</button>
                                    </div>
                                </form>
                            </section>

                            <section class="dev-group">
                                <h3 class="dev-group-title">
                                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M3 12h18"></path>
                                        <path d="M12 3v18"></path>
                                        <path d="M7 7h10v10H7z"></path>
                                    </svg>
                                    Audit Logs
                                </h3>
                                <p>Download the full activity log for all user actions.</p>
                                <div class="dev-row dev-row-single">
                                    <a class="dev-link" href="/admin/audit-log?format=xlsx">Download Audit Log (Excel)</a>
                                </div>
                            </section>
                        </div>
                    </details>
                    {% endif %}
                </div>
            </div>
        </section>

        {% if info_message %}
        <div class="notice">{{ info_message }}</div>
        {% endif %}

        <section class="stats">
            <div class="stat">
                <span>Subjects</span>
                <strong>{{ subject_count }}</strong>
            </div>
            <div class="stat">
                <span>Teachers</span>
                <strong>{{ teacher_count }}</strong>
            </div>
            <div class="stat">
                <span>Users</span>
                <strong>{{ users_count }}</strong>
            </div>
        </section>

        <section class="workspace">
            <div class="tabs">
                <button class="tab active" type="button" data-panel="subjects">
                    <svg class="tab-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 3H20v18H6.5A2.5 2.5 0 0 1 4 18.5v-13A2.5 2.5 0 0 1 6.5 3z"></path>
                    </svg>
                    <span>Subjects</span>
                </button>
                <button class="tab" type="button" data-panel="teachers">
                    <svg class="tab-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M20 8v6"></path>
                        <path d="M23 11h-6"></path>
                    </svg>
                    <span>Teachers</span>
                </button>
                {% if is_admin %}
                <button class="tab" type="button" data-panel="users">
                    <svg class="tab-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.9"></path>
                        <path d="M16 3.1a4 4 0 0 1 0 7.8"></path>
                    </svg>
                    <span>Users</span>
                </button>
                {% endif %}
                <button class="tab" type="button" data-panel="planning">
                    <svg class="tab-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M8 6h13"></path>
                        <path d="M8 12h13"></path>
                        <path d="M8 18h13"></path>
                        <path d="M3 6h.01"></path>
                        <path d="M3 12h.01"></path>
                        <path d="M3 18h.01"></path>
                    </svg>
                    <span>Planning</span>
                </button>
                <button class="tab" type="button" data-panel="reports">
                    <svg class="tab-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 3v18h18"></path>
                        <path d="M7 13l3-3 3 2 4-5"></path>
                    </svg>
                    <span>Reports</span>
                </button>
            </div>

            <div class="panel active" id="panel-subjects">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <h3>Subjects Workspace</h3>
                            <a class="icon-action" href="/subjects" aria-label="Open subjects quick actions" title="Open subjects quick actions">
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M8 6h10"></path>
                                    <path d="M8 12h10"></path>
                                    <path d="M8 18h10"></path>
                                    <path d="M4 6h.01"></path>
                                    <path d="M4 12h.01"></path>
                                    <path d="M4 18h.01"></path>
                                </svg>
                            </a>
                        </div>
                        <p>Manage curriculum subjects for your current branch and academic year.</p>
                    </div>
                </div>
                {% if subjects_dashboard_rows %}
                <div class="subject-level-dashboard">
                    <div class="subject-level-kpis">
                        <div class="subject-level-kpi">
                            <span>Total Subjects</span>
                            <strong id="dashboardTotalSubjects" class="subject-kpi-value" data-value="{{ subject_count }}">{{ subject_count }}</strong>
                            <small>In this branch/year scope</small>
                        </div>
                        <div class="subject-level-kpi">
                            <span>Total Weekly Hours</span>
                            <strong id="dashboardTotalWeeklyHours" class="subject-kpi-value" data-value="0">0</strong>
                            <small>Across all levels</small>
                        </div>
                        <div class="subject-level-kpi">
                            <span>Selected Level</span>
                            <strong id="dashboardSelectedLevelLabel">All Levels</strong>
                            <small id="dashboardSelectedLevelSummary">Subjects: 0 | Hours: 0</small>
                        </div>
                    </div>
                    <div id="dashboardSubjectGradeChipBar" class="subject-grade-chip-bar"></div>
                </div>
                <div class="subject-toolbar">
                    <input id="dashboardSubjectSearch" class="subject-filter-input" type="text" placeholder="Search by code, name, grade, or hours">
                </div>
                <div class="table-wrap">
                    <table>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Weekly Hours</th>
                            <th>Grade</th>
                        </tr>
                        {% for subject in subjects_dashboard_rows %}
                        <tr class="dashboard-subject-row" data-grade="{{ 'KG' if subject.grade == 0 else subject.grade }}" data-hours="{{ subject.weekly_hours or 0 }}">
                            <td>{{ subject.subject_code }}</td>
                            <td>{{ subject.subject_name }}</td>
                            <td>{{ subject.weekly_hours }}</td>
                            <td>{{ "KG" if subject.grade == 0 else subject.grade }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                <div id="dashboardNoSubjectResult" class="empty" style="display:none;">No subjects match the selected level/search filters.</div>
                {% else %}
                <div class="empty">No subjects yet. Open the Subjects module to add your first record.</div>
                {% endif %}
            </div>

            <div class="panel" id="panel-teachers">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <h3>Teachers Workspace</h3>
                            <a class="icon-action" href="/teachers" aria-label="Open teachers quick actions" title="Open teachers quick actions">
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M20 8v6"></path>
                                    <path d="M23 11h-6"></path>
                                </svg>
                            </a>
                        </div>
                        <p>Manage teaching staff assigned to this branch and year.</p>
                    </div>
                </div>
                {% if teachers_preview %}
                <div class="table-wrap">
                    <table>
                        <tr>
                            <th>Teacher ID</th>
                            <th>Name</th>
                            <th>Subject Code</th>
                            <th>Extra Hours Count</th>
                            <th>Total Hours Capacity</th>
                        </tr>
                        {% for teacher in teachers_preview %}
                        <tr>
                            <td>{{ teacher.teacher_id }}</td>
                            <td>{{ teacher.first_name }}{% if teacher.middle_name %} {{ teacher.middle_name }}{% endif %} {{ teacher.last_name }}</td>
                            <td>{{ teacher.subject_code }}</td>
                            <td>{{ teacher.extra_hours_count if teacher.extra_hours_allowed else 0 }}</td>
                            <td>{{ (teacher.max_hours or 24) + (teacher.extra_hours_count if teacher.extra_hours_allowed else 0) }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% else %}
                <div class="empty">No teacher records yet. Open the Teachers module to add your first record.</div>
                {% endif %}
            </div>

            {% if is_admin %}
            <div class="panel" id="panel-users">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <h3>Users Workspace</h3>
                            <a class="icon-action" href="/users" aria-label="Open users quick actions" title="Open users quick actions">
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.9"></path>
                                    <path d="M16 3.1a4 4 0 0 1 0 7.8"></path>
                                </svg>
                            </a>
                        </div>
                        <p>Manage non-teacher users, roles, and branch assignments.</p>
                    </div>
                </div>
                {% if users_preview %}
                <div class="table-wrap">
                    <table>
                        <tr>
                            <th>Name</th>
                            <th>User ID</th>
                            <th>Position</th>
                            <th>Role</th>
                            <th>Branch</th>
                            <th>Academic Year</th>
                            <th>Status</th>
                        </tr>
                        {% for row in users_preview %}
                        <tr>
                            <td>{{ row.first_name }} {{ row.last_name }}</td>
                            <td>{{ row.user_id or row.username }}</td>
                            <td>{{ row.position or "-" }}</td>
                            <td>{{ row.role or "-" }}</td>
                            <td>{{ branch_map.get(row.branch_id, "Not assigned") }}</td>
                            <td>{{ year_map.get(row.academic_year_id, "-") }}</td>
                            <td>{{ "Active" if row.is_active else "Inactive" }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% else %}
                <div class="empty">No user records yet for this branch/year scope.</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="panel" id="panel-planning">
                <div class="panel-head">
                    <div>
                        <div class="panel-title">
                            <h3>Planning Workspace</h3>
                            <a class="icon-action" href="/planning" aria-label="Open planning quick actions" title="Open planning quick actions">
                                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M8 6h13"></path>
                                    <path d="M8 12h13"></path>
                                    <path d="M8 18h13"></path>
                                    <path d="M3 6h.01"></path>
                                    <path d="M3 12h.01"></path>
                                    <path d="M3 18h.01"></path>
                                </svg>
                            </a>
                        </div>
                        <p>Interactive planning will calculate teacher load and section demand.</p>
                    </div>
                </div>
                <div class="planning-metrics">
                    <div class="planning-kpi planning-kpi-current">
                        <span>Total Planned Sections</span>
                        <strong class="planning-kpi-value" data-value="{{ planning_total_sections }}">{{ planning_total_sections }}</strong>
                        <p>Captured sections for this branch/year scope.</p>
                    </div>
                    <div class="planning-kpi planning-kpi-new">
                        <span>Current vs New Sections</span>
                        <strong class="planning-kpi-value" data-value="{{ planning_new_sections_count }}">{{ planning_new_sections_count }}</strong>
                        <p>Current: {{ planning_current_sections_count }} | New: {{ planning_new_sections_count }}</p>
                    </div>
                    <div class="planning-kpi planning-kpi-hours">
                        <span>Total Allocated Hours</span>
                        <strong class="planning-kpi-value" data-value="{{ planning_total_allocated_hours }}">{{ planning_total_allocated_hours }}</strong>
                        <p>Automatically calculated by grade-subject alignment.</p>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-reports">
                <div class="panel-head">
                    <div>
                        <h3>Reports Workspace</h3>
                        <p>Year-based teacher sufficiency forecast across subjects, teachers, and planning.</p>
                    </div>
                    <a class="open-link" href="/planning">Open Planning</a>
                </div>
                <div class="report-note">
                    This report uses a fixed <strong>24 hours/week</strong> cap per existing teacher (standard allocation rule), regardless of custom Max Hours or Extra Hours settings.
                </div>
                {% if report_summary.total_required_hours > 0 %}
                <div class="report-decision-strip">
                    <div class="report-decision-card report-decision-classes">
                        <span>New Classes to Open</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_new_sections_planned }}">{{ report_summary.total_new_sections_planned }}</strong>
                        <p>Planned new sections in this branch and academic year.</p>
                    </div>
                    <div class="report-decision-card report-decision-new-teachers">
                        <span>New Teachers Required</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_new_teachers_required }}">{{ report_summary.total_new_teachers_required }}</strong>
                        <p>Required hires based on uncovered subject hours.</p>
                    </div>
                    <div class="report-decision-card report-decision-total">
                        <span>Total Teachers Needed (Branch)</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_teachers_needed_branch }}">{{ report_summary.total_teachers_needed_branch }}</strong>
                        <p>Current teachers {{ report_summary.total_existing_teachers }} + new required {{ report_summary.total_new_teachers_required }}.</p>
                    </div>
                </div>

                <div class="report-kpis">
                    <div class="report-kpi report-kpi-hours">
                        <span>Total Required Hours</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_required_hours }}">{{ report_summary.total_required_hours }}</strong>
                        <p>Current classes + new planned classes.</p>
                    </div>
                    <div class="report-kpi report-kpi-covered">
                        <span>Expected Covered Hours</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_allocated_hours }}">{{ report_summary.total_allocated_hours }}</strong>
                        <p>Allocated to existing teachers using 24h max each.</p>
                    </div>
                    <div class="report-kpi report-kpi-gap">
                        <span>Uncovered Hours</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_remaining_hours }}">{{ report_summary.total_remaining_hours }}</strong>
                        <p>Remaining subject hours not covered by current teachers.</p>
                    </div>
                    <div class="report-kpi report-kpi-teachers">
                        <span>New Teachers Required</span>
                        <strong class="report-kpi-value" data-value="{{ report_summary.total_additional_teachers_needed }}">{{ report_summary.total_additional_teachers_needed }}</strong>
                        <p>Subject-specific requirement based on remaining hours.</p>
                    </div>
                </div>

                <div class="report-coverage">
                    <div class="report-coverage-meta">
                        <span>Coverage Rate by Existing Teachers</span>
                        <h4 class="report-coverage-rate"><span class="report-kpi-value" data-value="{{ report_summary.coverage_percentage }}">{{ report_summary.coverage_percentage }}</span>%</h4>
                        <small>Current demand: {{ report_summary.total_required_current_hours }}h | New demand: {{ report_summary.total_required_new_hours }}h</small>
                    </div>
                    <div class="report-coverage-track">
                        <div id="reportCoverageFill" class="report-coverage-fill" data-width="{{ report_summary.coverage_percentage }}"></div>
                    </div>
                </div>

                <div class="report-layout">
                    <div class="report-card">
                        <h4>Subject Sufficiency Breakdown</h4>
                        <p>Hours are aggregated by subject across all grades (KG to Grade 12) in the selected academic year scope.</p>
                        <div class="table-wrap report-table">
                            <table>
                                <tr>
                                    <th>Subject</th>
                                    <th>Grades</th>
                                    <th>Current Hours</th>
                                    <th>New Hours</th>
                                    <th>Total Required</th>
                                    <th>Covered</th>
                                    <th>Uncovered</th>
                                    <th>Coverage %</th>
                                    <th>Teachers in Subject</th>
                                    <th>Extra Teachers Needed</th>
                                </tr>
                                {% for row in report_subject_rows %}
                                <tr>
                                    <td>{{ row.subject_name }}</td>
                                    <td>{{ row.grades | join(", ") }}</td>
                                    <td>{{ row.required_current_hours }}</td>
                                    <td>{{ row.required_new_hours }}</td>
                                    <td>{{ row.required_hours }}</td>
                                    <td>{{ row.allocated_hours }}</td>
                                    <td class="{{ 'report-status-gap' if row.remaining_hours > 0 else 'report-status-good' }}">{{ row.remaining_hours }}</td>
                                    <td>{{ row.coverage_percentage }}%</td>
                                    <td>{{ row.teachers_with_subject }}</td>
                                    <td class="{{ 'report-status-gap' if row.additional_teachers_needed > 0 else 'report-status-good' }}">
                                        {{ row.additional_teachers_needed }}
                                        {% if row.additional_teachers_note %}
                                        <div class="report-inline-note">{{ row.additional_teachers_note }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>

                    <div class="report-card">
                        <h4>Uncovered Hours by Subject</h4>
                        <p>Top subjects with remaining weekly demand after existing teacher allocation.</p>
                        {% if report_gap_rows %}
                        <div class="report-gap-list">
                            {% for row in report_gap_rows %}
                            <div class="report-gap-row">
                                <div class="report-gap-head">
                                    <span>{{ row.subject_name }}</span>
                                    <strong>{{ row.remaining_hours }}h</strong>
                                </div>
                                <div class="report-gap-track">
                                    <div class="report-gap-fill" data-width="{{ row.gap_chart_pct }}"></div>
                                </div>
                                <small>Additional teachers required: {{ row.additional_teachers_needed }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty">All required hours are covered by existing teachers.</div>
                        {% endif %}

                        <h4 class="report-subtitle">Demand by Grade</h4>
                        {% if report_grade_rows %}
                        <div class="table-wrap report-grade-table">
                            <table>
                                <tr>
                                    <th>Grade</th>
                                    <th>Current Sections</th>
                                    <th>New Sections</th>
                                    <th>Total Sections</th>
                                    <th>Current Hours</th>
                                    <th>New Hours</th>
                                    <th>Total Hours</th>
                                </tr>
                                {% for grade_row in report_grade_rows %}
                                <tr>
                                    <td>{{ grade_row.grade_label }}</td>
                                    <td>{{ grade_row.sections_current }}</td>
                                    <td>{{ grade_row.sections_new }}</td>
                                    <td>{{ grade_row.sections_total }}</td>
                                    <td>{{ grade_row.required_hours_current }}</td>
                                    <td>{{ grade_row.required_hours_new }}</td>
                                    <td>{{ grade_row.required_hours_total }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% else %}
                        <div class="empty">No grade demand data is available in this scope yet.</div>
                        {% endif %}
                    </div>
                </div>

                <div class="report-card report-teachers-card">
                    <h4>Expected Allocation for Existing Teachers (24h max)</h4>
                    <p>Each teacher is anchored to one primary subject (highest currently assigned hours), then support subject is used only if capacity remains, with a strict 24h cap.</p>
                    {% if report_teacher_rows %}
                    <div class="table-wrap report-table">
                        <table>
                            <tr>
                                <th>Teacher ID</th>
                                <th>Name</th>
                                <th>Subject Coverage</th>
                                <th>Expected Allocated Hours</th>
                                <th>Remaining Capacity</th>
                            </tr>
                            {% for row in report_teacher_rows %}
                            <tr>
                                <td>{{ row.teacher_id }}</td>
                                <td>{{ row.teacher_name }}</td>
                                <td>
                                    {% if row.subject_labels %}
                                    Primary (highest assigned hours): {{ row.subject_labels | join(", ") }}
                                    <div class="report-inline-note">Current assigned hours in primary: {{ row.primary_subject_basis_hours }}h</div>
                                    {% else %}
                                    Primary: -
                                    {% endif %}
                                    {% if row.support_subject_labels %}
                                    <div class="report-inline-note">Eligible support only after primary hours and still within 24h: {{ row.support_subject_labels | join(", ") }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong class="{{ 'report-hours-full' if row.expected_allocated_hours == 24 else 'report-hours-under' }}">{{ row.expected_allocated_hours }}h</strong>
                                    <div class="report-inline-note">Primary allocated: {{ row.primary_allocated_hours }}h | Support allocated: {{ row.support_allocated_hours }}h</div>
                                    {% if row.allocation_labels %}
                                    <div class="report-inline-note">{{ row.allocation_labels | join(", ") }}</div>
                                    {% endif %}
                                </td>
                                <td>{{ row.remaining_capacity_hours }}h</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% else %}
                    <div class="empty">No teacher records found in this branch/year scope.</div>
                    {% endif %}
                    <div class="report-footnote">
                        Existing teachers tracked: {{ report_summary.total_existing_teachers }} | Aligned to at least one report subject: {{ report_summary.teachers_with_subject_alignment }} | Utilized in forecast: {{ report_summary.teachers_utilized }} | Full load (24h): {{ report_summary.teachers_full_load }} | Idle capacity: {{ report_summary.unused_existing_capacity_hours }}h.
                    </div>
                </div>
                {% else %}
                <div class="empty">
                    No report output yet for this branch/year scope. Add planned sections and subject weekly hours to generate teacher sufficiency analytics.
                </div>
                {% endif %}
            </div>
        </section>
    </div>

    <script>
        const tabs = document.querySelectorAll(".tab");
        const panels = document.querySelectorAll(".panel");
        const dashboardSubjectRows = Array.from(document.querySelectorAll(".dashboard-subject-row"));
        const dashboardSubjectSearch = document.getElementById("dashboardSubjectSearch");
        const dashboardNoSubjectResult = document.getElementById("dashboardNoSubjectResult");
        const dashboardSubjectGradeChipBar = document.getElementById("dashboardSubjectGradeChipBar");
        const dashboardTotalSubjects = document.getElementById("dashboardTotalSubjects");
        const dashboardTotalWeeklyHours = document.getElementById("dashboardTotalWeeklyHours");
        const dashboardSelectedLevelLabel = document.getElementById("dashboardSelectedLevelLabel");
        const dashboardSelectedLevelSummary = document.getElementById("dashboardSelectedLevelSummary");
        const subjectKpiValues = Array.from(document.querySelectorAll(".subject-kpi-value"));
        const planningKpiValues = Array.from(document.querySelectorAll(".planning-kpi-value"));
        const reportKpiValues = Array.from(document.querySelectorAll(".report-kpi-value"));
        const reportGapFills = Array.from(document.querySelectorAll(".report-gap-fill"));
        const reportCoverageFill = document.getElementById("reportCoverageFill");
        const subjectGradeOrder = ["KG", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"];
        let activeDashboardGrade = "ALL";
        let subjectKpiAnimated = false;
        let planningKpiAnimated = false;
        let reportKpiAnimated = false;
        let reportBarsAnimated = false;

        const animateNumericValue = (element) => {
            const target = Number(element.dataset.value || element.textContent || "0");
            if (!Number.isFinite(target) || target <= 0) {
                element.textContent = "0";
                return;
            }

            const durationMs = 700;
            const startAt = performance.now();

            const tick = (timestamp) => {
                const progress = Math.min((timestamp - startAt) / durationMs, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                element.textContent = String(Math.round(target * eased));
                if (progress < 1) {
                    requestAnimationFrame(tick);
                }
            };

            requestAnimationFrame(tick);
        };

        const animatePlanningKpis = () => {
            if (planningKpiAnimated) {
                return;
            }
            planningKpiValues.forEach((element) => animateNumericValue(element));
            planningKpiAnimated = true;
        };

        const animateReportKpis = () => {
            if (reportKpiAnimated) {
                return;
            }
            reportKpiValues.forEach((element) => animateNumericValue(element));
            reportKpiAnimated = true;
        };

        const animateReportBars = () => {
            if (reportBarsAnimated) {
                return;
            }

            const applyWidth = (element) => {
                if (!element) {
                    return;
                }
                const targetWidth = Number(element.dataset.width || "0");
                const safeWidth = Math.max(0, Math.min(100, targetWidth));
                requestAnimationFrame(() => {
                    element.style.width = `${safeWidth}%`;
                });
            };

            applyWidth(reportCoverageFill);
            reportGapFills.forEach((element) => applyWidth(element));
            reportBarsAnimated = true;
        };

        const getDashboardRowGrade = (row) => {
            const rawGrade = String(row.dataset.grade || "").trim().toUpperCase();
            if (rawGrade === "0" || rawGrade === "KG") {
                return "KG";
            }
            return rawGrade;
        };

        const getDashboardRowHours = (row) => {
            const parsedHours = Number(row.dataset.hours || "0");
            return Number.isFinite(parsedHours) ? parsedHours : 0;
        };

        const getDashboardGradeLabel = (grade) => {
            if (grade === "ALL") {
                return "All Levels";
            }
            if (grade === "KG") {
                return "KG";
            }
            return `Grade ${grade}`;
        };

        const buildDashboardGradeStats = () => {
            const stats = {};
            subjectGradeOrder.forEach((grade) => {
                stats[grade] = { subjects: 0, hours: 0 };
            });

            dashboardSubjectRows.forEach((row) => {
                const grade = getDashboardRowGrade(row);
                if (!stats[grade]) {
                    stats[grade] = { subjects: 0, hours: 0 };
                }
                stats[grade].subjects += 1;
                stats[grade].hours += getDashboardRowHours(row);
            });

            return stats;
        };

        const dashboardGradeStats = buildDashboardGradeStats();
        const dashboardAllTotals = dashboardSubjectRows.reduce((total, row) => {
            total.subjects += 1;
            total.hours += getDashboardRowHours(row);
            return total;
        }, { subjects: 0, hours: 0 });

        const updateDashboardSubjectSummary = (subjectsCount, totalHours) => {
            if (!dashboardSelectedLevelLabel || !dashboardSelectedLevelSummary) {
                return;
            }
            dashboardSelectedLevelLabel.textContent = getDashboardGradeLabel(activeDashboardGrade);
            dashboardSelectedLevelSummary.textContent = `Subjects: ${subjectsCount} | Hours: ${totalHours}`;
        };

        const renderDashboardSubjectGradeChips = () => {
            if (!dashboardSubjectGradeChipBar) {
                return;
            }

            dashboardSubjectGradeChipBar.innerHTML = "";
            const chipList = ["ALL", ...subjectGradeOrder];

            chipList.forEach((grade) => {
                const chip = document.createElement("button");
                chip.type = "button";
                chip.className = "subject-grade-chip";
                chip.dataset.grade = grade;
                const stats = grade === "ALL"
                    ? dashboardAllTotals
                    : (dashboardGradeStats[grade] || { subjects: 0, hours: 0 });
                chip.textContent = `${getDashboardGradeLabel(grade)} (${stats.subjects})`;
                if (grade === activeDashboardGrade) {
                    chip.classList.add("active");
                }
                chip.addEventListener("click", () => {
                    activeDashboardGrade = grade;
                    renderDashboardSubjectGradeChips();
                    applyDashboardSubjectFilters();
                });
                dashboardSubjectGradeChipBar.appendChild(chip);
            });
        };

        const applyDashboardSubjectFilters = () => {
            const term = dashboardSubjectSearch ? dashboardSubjectSearch.value.trim().toLowerCase() : "";
            let visibleCount = 0;
            let visibleHours = 0;

            dashboardSubjectRows.forEach((row) => {
                const gradeMatch = activeDashboardGrade === "ALL" || getDashboardRowGrade(row) === activeDashboardGrade;
                const searchMatch = (row.textContent || "").toLowerCase().includes(term);
                const match = gradeMatch && searchMatch;
                row.style.display = match ? "" : "none";
                if (match) {
                    visibleCount += 1;
                    visibleHours += getDashboardRowHours(row);
                }
            });

            if (dashboardNoSubjectResult) {
                dashboardNoSubjectResult.style.display = visibleCount === 0 ? "block" : "none";
            }

            if (dashboardTotalSubjects) {
                dashboardTotalSubjects.dataset.value = String(visibleCount);
                dashboardTotalSubjects.textContent = String(visibleCount);
            }

            if (dashboardTotalWeeklyHours) {
                dashboardTotalWeeklyHours.dataset.value = String(visibleHours);
                dashboardTotalWeeklyHours.textContent = String(visibleHours);
            }

            updateDashboardSubjectSummary(visibleCount, visibleHours);
        };

        const animateSubjectKpis = () => {
            if (subjectKpiAnimated) {
                return;
            }
            subjectKpiValues.forEach((element) => animateNumericValue(element));
            subjectKpiAnimated = true;
        };

        if (dashboardSubjectRows.length > 0) {
            renderDashboardSubjectGradeChips();
            applyDashboardSubjectFilters();
            if (dashboardSubjectSearch) {
                dashboardSubjectSearch.addEventListener("input", applyDashboardSubjectFilters);
            }
        }

        tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
                const target = tab.getAttribute("data-panel");

                tabs.forEach((item) => item.classList.remove("active"));
                panels.forEach((panel) => panel.classList.remove("active"));

                tab.classList.add("active");
                const panel = document.getElementById("panel-" + target);
                if (panel) {
                    panel.classList.add("active");
                }

                if (target === "planning") {
                    animatePlanningKpis();
                }

                if (target === "subjects") {
                    animateSubjectKpis();
                }

                if (target === "reports") {
                    animateReportKpis();
                    animateReportBars();
                }
            });
        });

        const activeSubjectsPanel = document.getElementById("panel-subjects");
        if (activeSubjectsPanel && activeSubjectsPanel.classList.contains("active")) {
            animateSubjectKpis();
        }

        const activePlanningPanel = document.getElementById("panel-planning");
        if (activePlanningPanel && activePlanningPanel.classList.contains("active")) {
            animatePlanningKpis();
        }

        const activeReportsPanel = document.getElementById("panel-reports");
        if (activeReportsPanel && activeReportsPanel.classList.contains("active")) {
            animateReportKpis();
            animateReportBars();
        }
    </script>
</body>
</html>


